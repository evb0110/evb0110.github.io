import{b as oe,x as we,r as h,c as R,aA as ue,o as i,f,n as r,k as w,m as C,p as P,ax as te,a5 as ve,F as H,j as v,_ as se,e as ae,g as a,aX as ie,v as G,h as t,i as de,aB as _e,av as I,at as fe,W as be,as as Te,V as Q,I as xe}from"./index-k42HC2iN.js";import{d as re,V as Ae,m as X,a as D,b as ne}from"./VDataTable-jdtbfCyu.js";import{a as Ce}from"./index-PucYgTTw.js";import{V as me,a as pe,b as he}from"./VCard-DYSTPYQX.js";import{f as ce,a as $e,b as Y,c as Z,g as ee,d as Se}from"./VSelect-F65GGIPF.js";import"./IDB-SQL5UDev.js";import"./index-Dob3nYDb.js";import"./VAvatar-CGw9XlwT.js";import"./transition-DxX8Rtql.js";import"./index-B2u6LIFc.js";import"./VCheckboxBtn-COHiaSHZ.js";import"./VField-B1YpfbDl.js";import"./VTable-DLfM5FQn.js";import"./VTextField-d0DcHfD6.js";import"./VOverlay-dj05eszF.js";import"./scopeId-BzWcKp0b.js";import"./dialog-transition-DVjFBXWV.js";import"./VSlideGroup-BeoSCyNZ.js";function ye(){const z=l=>!!(l.annotation&&l.annotation!==l.lemma),$=l=>z(l)||l.isArabic;return{shouldShowAnnotation:z,hasVisibleAnnotation:$,shouldShowIndicator:l=>z(l),shouldBeClickable:l=>$(l)}}const Me={class:"annotated-token-wrapper"},Ve=["aria-label"],Ue={class:"surface"},Be={key:0,class:"annotation-indicator"},Ie={key:1,class:"arabic-indicator"},Pe={key:2,class:"inline-lemma"},ze={class:"tooltip-content"},Re=oe({__name:"AnnotatedToken",props:{token:{},displayMode:{default:"indicators"},showAnnotations:{type:Boolean,default:!0}},setup(z){const $=z,{token:s,displayMode:y}=we($),{shouldShowAnnotation:l,hasVisibleAnnotation:k,shouldShowIndicator:c,shouldBeClickable:M}=ye(),b=h(!1),V=h(),u=h({top:0,left:0,arrow:"bottom"});let o=null;const _=R(()=>({"has-lemma":!!s.value.lemma,"has-variants":!!(s.value.variants&&s.value.variants.length>0),"has-morphology":!!(s.value.morphology&&s.value.morphology.length>0),"has-prefix":!!s.value.prefix,"has-annotation":c(s.value),"is-arabic":s.value.isArabic,"is-clickable":M(s.value),[`display-${y.value}`]:!0})),g=R(()=>y.value==="indicators"||y.value==="detailed"),m=R(()=>{const U=[`Word: ${s.value.surface}`];return s.value.lemma&&U.push(`Lemma: ${s.value.lemma}`),s.value.variants&&s.value.variants.length>0&&U.push(`Variants: ${s.value.variants.join(", ")}`),s.value.isArabic&&U.push("Arabic"),U.join(", ")}),n=U=>{y.value!=="minimal"&&k($.token)&&(o=setTimeout(()=>{T(U),b.value=!0},300))},T=U=>{const L=U.target.getBoundingClientRect(),q=200,N=60,B=5;let O=L.top-N-B,E=L.left+L.width/2-q/2,J="bottom";O<B&&(O=L.bottom+B,J="top"),E<B&&(E=B),E+q>window.innerWidth-B&&(E=window.innerWidth-q-B),u.value={top:O,left:E,arrow:J}},S=()=>{o&&(clearTimeout(o),o=null),b.value=!1};return ue(()=>{o&&clearTimeout(o)}),(U,F)=>(i(),f("span",Me,[r("span",{class:te(["annotated-token",_.value]),onMouseenter:n,onMouseleave:S,"aria-label":m.value},[r("span",Ue,w(C(s).surface),1),g.value&&C(c)(C(s))?(i(),f("sup",Be,"°")):g.value&&C(s).isArabic&&!C(c)(C(s))?(i(),f("sup",Ie,"ع")):P("",!0),C(y)==="inline"&&C(s).lemma?(i(),f("span",Pe," ("+w(C(s).lemma)+") ",1)):P("",!0)],42,Ve),b.value&&C(s)&&C(k)(C(s))?(i(),f("div",{key:0,class:te(["annotation-tooltip",`arrow-${u.value.arrow}`]),ref_key:"tooltip",ref:V,style:ve({top:`${u.value.top}px`,left:`${u.value.left}px`})},[r("div",ze,[C(l)(C(s))?(i(),f(H,{key:0},[v(w(C(s).annotation),1)],64)):C(s).isArabic?(i(),f(H,{key:1},[v(" Arabic ")],64)):P("",!0)])],6)):P("",!0)]))}}),Le=se(Re,[["__scopeId","data-v-f5320d92"]]),Ee={class:"annotation-display"},De={key:0,class:"text-center pa-8"},Fe={key:2,class:"utterances-container"},Ne=["onClick"],qe={class:"d-flex ga-3"},Oe={class:"utterance-number mr-2"},je={class:"flex-grow-1"},We={class:"detailed-tokens"},Xe=["onClick"],He={key:0,class:"utterance-expansion mt-3"},Ge={key:3,class:"text-center pa-8 text-grey"},Je=oe({__name:"AnnotationDisplay",props:{utterances:{},isLoading:{type:Boolean,default:!1},error:{default:""},highlightedUtterance:{default:-1}},emits:["utterance-click"],setup(z,{expose:$}){const s=z,y=h(new Set),{shouldShowAnnotation:l}=ye(),k=[{title:"Surface",key:"surface",sortable:!1},{title:"Annotation",key:"annotation",sortable:!1}],c=R(()=>{if(!s.utterances||s.utterances.length===0)return{totalTokens:0,annotatedTokens:0,arabicTokens:0,morphologyTokens:0};let u=0,o=0,_=0,g=0;try{for(const m of s.utterances)if(m.tokens){u+=m.tokens.length;for(const n of m.tokens)l(n)&&o++,n.isArabic&&_++,n.morphology&&n.morphology.length>0&&g++}}catch{}return{totalTokens:u,annotatedTokens:o,arabicTokens:_,morphologyTokens:g}});R(()=>c.value.totalTokens),R(()=>c.value.annotatedTokens),R(()=>c.value.arabicTokens),R(()=>c.value.morphologyTokens),$({statistics:c});const M=u=>{const o=new Set(y.value);o.has(u)?o.delete(u):o.add(u),y.value=o},b=new Map,V=u=>{if(b.has(u.number))return b.get(u.number);const o=new Set,_=u.tokens.filter(g=>l(g)||g.isArabic||g.prefix).filter(g=>{const m=`${g.surface}|${g.annotation||"—"}`;return o.has(m)?!1:(o.add(m),!0)}).map(g=>({surface:g.surface,annotation:l(g)?g.annotation:g.isArabic?"Arabic":"—"}));return b.set(u.number,_),_};return ae(()=>s.utterances,()=>{b.clear()},{immediate:!0}),(u,o)=>(i(),f("div",Ee,[u.isLoading?(i(),f("div",De,[a(ie,{indeterminate:""}),o[0]||(o[0]=r("div",{class:"mt-2"},"Parsing annotations...",-1))])):u.error?(i(),G(re,{key:1,type:"error",class:"mb-4"},{default:t(()=>[v(w(u.error),1)]),_:1})):u.utterances.length>0?(i(),f("div",Fe,[(i(!0),f(H,null,de(u.utterances,(_,g)=>(i(),f("div",{key:`utterance-${_.number}-${g}`,class:"utterance-item",onClick:m=>u.$emit("utterance-click",_.number)},[r("div",qe,[r("div",{class:te(["d-flex align-start flex-grow-1",{"utterance-highlighted":u.highlightedUtterance===_.number}])},[r("span",Oe,w(_.number),1),r("div",je,[r("div",We,[(i(!0),f(H,null,de(_.tokens,(m,n)=>(i(),f(H,{key:`detailed-${m.position}-${n}`},[a(Le,{token:m,"display-mode":"detailed","show-annotations":!0,class:"detailed-token"},null,8,["token"]),m.spaceAfter?(i(),f(H,{key:0},[v(w(" "))],64)):P("",!0)],64))),128))])])],2),r("button",{class:"expand-button",onClick:_e(m=>M(_.number),["stop"])},[a(I,{size:"small",class:te(["expand-icon",{rotated:y.value.has(_.number)}])},{default:t(()=>o[1]||(o[1]=[v(w("mdi-chevron-right"))])),_:2},1032,["class"])],8,Xe)]),a(Ce,null,{default:t(()=>[y.value.has(_.number)?(i(),f("div",He,[a(me,{variant:"outlined",density:"compact"},{default:t(()=>[a(pe,{class:"text-subtitle-2"},{default:t(()=>o[2]||(o[2]=[v(" Token Analysis ")])),_:1}),a(he,null,{default:t(()=>[a(Ae,{headers:k,items:V(_),"items-per-page":-1,density:"compact","hide-default-footer":"",class:"token-analysis-table"},null,8,["items"])]),_:2},1024)]),_:2},1024)])):P("",!0)]),_:2},1024)],8,Ne))),128))])):(i(),f("div",Ge,[a(I,{size:"48",class:"mb-2"},{default:t(()=>o[3]||(o[3]=[v("mdi-text-box-remove")])),_:1}),o[4]||(o[4]=r("div",null,"No annotations to display",-1))]))]))}}),Ke=se(Je,[["__scopeId","data-v-5fc824b6"]]),Qe={class:"minimal-audio-player"},Ye=["disabled"],Ze={key:0,width:"32",height:"32",viewBox:"0 0 24 24",fill:"none"},et={key:1,width:"32",height:"32",viewBox:"0 0 24 24",fill:"none"},tt={class:"time-display"},at={class:"progress-bar"},ot=oe({__name:"MinimalAudioPlayer",props:{src:{},audioRef:{}},emits:["play","pause","ended","timeupdate"],setup(z,{expose:$,emit:s}){const y=z,l=s,k=h(),c=h(!1),M=h(0),b=h(0),V=h(!1),u=R(()=>b.value?M.value/b.value*100:0),o=n=>{const T=Math.floor(n/60),S=Math.floor(n%60);return`${T}:${S.toString().padStart(2,"0")}`},_=()=>{k.value&&(c.value?k.value.pause():k.value.play())},g=n=>{if(!k.value||!b.value)return;const S=n.currentTarget.getBoundingClientRect(),L=(n.clientX-S.left)/S.width*b.value;k.value.currentTime=L,M.value=L},m=()=>{y.audioRef?k.value=y.audioRef:k.value=new Audio(y.src);const n=k.value;n.addEventListener("loadedmetadata",()=>{b.value=n.duration,V.value=!0}),n.addEventListener("timeupdate",()=>{M.value=n.currentTime,l("timeupdate",n.currentTime)}),n.addEventListener("play",()=>{c.value=!0,l("play")}),n.addEventListener("pause",()=>{c.value=!1,l("pause")}),n.addEventListener("ended",()=>{c.value=!1,l("ended")}),n.readyState>=1&&(b.value=n.duration,V.value=!0)};return ae(()=>y.src,n=>{k.value&&!y.audioRef&&(k.value.src=n,V.value=!1,M.value=0,b.value=0)}),fe(()=>{m()}),ue(()=>{k.value&&!y.audioRef&&(k.value.pause(),k.value.src="")}),$({audio:k}),(n,T)=>(i(),f("div",Qe,[r("button",{class:"play-button",onClick:_,disabled:!V.value},[c.value?(i(),f("svg",et,T[1]||(T[1]=[r("rect",{x:"6",y:"4",width:"4",height:"16",fill:"currentColor"},null,-1),r("rect",{x:"14",y:"4",width:"4",height:"16",fill:"currentColor"},null,-1)]))):(i(),f("svg",Ze,T[0]||(T[0]=[r("path",{d:"M8 5v14l11-7z",fill:"currentColor"},null,-1)])))],8,Ye),r("div",tt,w(o(M.value))+" / "+w(o(b.value)),1),r("div",{class:"progress-container",onClick:g},[r("div",at,[r("div",{class:"progress-fill",style:ve({width:u.value+"%"})},null,4)])])]))}}),st=se(ot,[["__scopeId","data-v-40c28804"]]),lt={class:"masc-viewer-layout"},nt={class:"viewer-header"},it={class:"header-content"},rt={key:0,class:"title-section d-flex align-baseline flex-wrap ga-16"},ut={class:"text-h6 mb-0"},dt={class:"text-body-2"},ct={key:1,class:"viewer-body"},vt={class:"content-area"},ft={class:"transcription-section"},mt={key:0,class:"audio-download-prompt pa-3 flex-1-0"},pt={class:"d-flex align-center justify-space-between"},ht={class:"text-caption"},yt={key:1,class:"audio-controls full-width"},gt={key:1,class:"no-audio-text"},kt={class:"utterances-scroll"},wt={key:0,class:"text-center pa-8"},_t={key:1},bt={key:3,class:"text-center pa-4 text-grey"},Tt={key:2,class:"empty-state"},xt=oe({__name:"MASCViewer",setup(z){const $=be(),s=Te(),y=h($.params.textId),l=h(null),k=h(null),c=h(null),M=h(null),b=h(null),V=h("full"),u=h(!0),o=h(!0),_=h([]),g=h([]),m=h(""),n=h(new Map),T=h(-1),S=h(!1),U=R(()=>b.value?b.value.statistics.annotatedTokens:0),F=h({plainUtterances:[],surfaceUtterances:[],annotatedUtterances:[],loaded:!1}),L=async()=>{try{const[d,e]=await Promise.all([D.getTranscription(y.value,!1),D.getTranscription(y.value,!0)]);if(!d||!e)return;F.value={plainUtterances:ne.parseTranscription(d),surfaceUtterances:ne.parseLemmatizedTranscription(e),annotatedUtterances:ne.parseAnnotatedTranscription(e),loaded:!0},q()}catch{m.value="Failed to load transcription"}},q=()=>{if(F.value.loaded)switch(V.value){case"plain":_.value=F.value.plainUtterances,g.value=[];break;case"full":_.value=[],g.value=F.value.annotatedUtterances;break}},N=h(!1),B=h(!1),O=h(0),E=async()=>{o.value=!0,N.value=!1;try{const d=await D.getAudioBlob(y.value);if(d)k.value=D.createAudioUrl(d);else{const p=await X.checkAudioForText(y.value);console.log("[MASCViewer] Audio info:",p),p.exists&&!p.downloaded&&(N.value=!0,O.value=Math.round((p.size||0)/(1024*1024)*10)/10)}const e=await D.getUtteranceTimings(y.value);e&&(n.value=e)}catch(d){console.error("[MASCViewer] Error loading audio:",d)}finally{o.value=!1}},J=async()=>{B.value=!0;try{const d=await X.checkAudioForText(y.value);d.exists&&d.path?(console.log("[MASCViewer] Downloading audio file:",d.path),await X.downloadSingleFile(d.path)?(N.value=!1,await E()):m.value="Failed to download audio file"):m.value="Audio file not found for this text"}catch(d){console.error("[MASCViewer] Error downloading audio:",d),m.value=d.message||"Failed to download audio file"}finally{B.value=!1}},ge=d=>{if(!c.value||!n.value.has(d))return;const e=n.value.get(d);e&&(T.value===d&&S.value?c.value.pause():(c.value.currentTime=e.start,S.value||c.value.play()))},ke=()=>{if(!c.value||n.value.size===0)return;const d=c.value.currentTime;let e=-1;for(const[p,A]of n.value)if(d>=A.start&&d<A.end){e=p;break}if(e!==T.value){const p=T.value;T.value=e,e>0&&(S.value||Math.abs(e-p)>1)&&le(e)}},le=d=>{const e=document.querySelector(".utterances-scroll");if(!e)return;let p=null;if(V.value==="full"){const A=e.querySelectorAll(".utterance-item");A.length>0&&A.forEach(x=>{var j;const K=x.querySelector(".utterance-number");K&&((j=K.textContent)==null?void 0:j.trim())===String(d)&&(p=x)})}else{const A=e.querySelectorAll(".utterance-item"),x=d-1;x>=0&&x<A.length&&(p=A[x])}if(p){const A=e.getBoundingClientRect(),W=p.getBoundingClientRect().top-A.top+e.scrollTop-100;e.scrollTo({top:Math.max(0,W),behavior:"smooth"})}};return ae(V,()=>{q()}),ae(M,d=>{d&&d.audio&&(c.value=d.audio)}),fe(async()=>{try{if(await X.initialize(),await X.isDataReady())await D.setOnlineMode(X);else{let p=!1;try{const A=new Promise(x=>setTimeout(()=>x(!1),1e3));p=await Promise.race([D.isDataLoaded(),A])}catch(A){console.log("[MASCViewer] Error checking folder-based data:",A),p=!1}if(!p)if($.query.from==="browser"){m.value="Unable to load MASC data. Please try downloading the corpus.",u.value=!1,o.value=!1;return}else{await s.push({name:"MASCBrowser",query:{returnTo:$.fullPath}});return}}const e=await D.getMetadata();if(l.value=e.find(p=>p.textId===y.value)||null,l.value){await L(),u.value=!1,await E();const p=$.query.utterance,A=$.query.autoplay==="true";if(p){const x=parseInt(p);isNaN(x)||(async()=>{let j=0;for(;!c.value&&j<20;)await new Promise(W=>setTimeout(W,100)),j++;if(c.value&&n.value.has(x)){const W=n.value.get(x);if(W&&(le(x),T.value=x,c.value.currentTime=W.start,A))try{await c.value.play()}catch{}}else le(x),T.value=x,setTimeout(()=>{T.value===x&&!S.value&&(T.value=-1)},3e3)})()}}else u.value=!1,o.value=!1}catch{m.value="Failed to load MASC data",u.value=!1,o.value=!1}}),ue(()=>{c.value&&(c.value.pause(),c.value.currentTime=0),k.value&&URL.revokeObjectURL(k.value)}),(d,e)=>(i(),f("div",lt,[r("div",nt,[r("div",it,[a(Q,{variant:"text",to:{name:"MASCBrowser"}},{default:t(()=>[a(I,null,{default:t(()=>e[4]||(e[4]=[v("mdi-arrow-left")])),_:1})]),_:1}),l.value?(i(),f("div",rt,[r("h1",ut,w(l.value.title),1),r("div",dt,[v(w(l.value.textId)+" — "+w(l.value.speakerName)+" ",1),a(ce,{size:"x-small",class:"ml-2"},{default:t(()=>[v(w(l.value.gender),1)]),_:1}),a(ce,{size:"x-small",class:"ml-1"},{default:t(()=>[v("Age: "+w(l.value.age),1)]),_:1})])])):P("",!0),l.value?(i(),G(Se,{key:1},{activator:t(({props:p})=>[a(Q,xe(p,{variant:"text",size:"x-large"}),{default:t(()=>[a(I,{size:"28",color:"grey-darken-1"},{default:t(()=>e[5]||(e[5]=[v("mdi-information-outline")])),_:1})]),_:2},1040)]),default:t(()=>[a(me,{"min-width":"300"},{default:t(()=>[a(pe,{class:"text-body-1"}),a(he,null,{default:t(()=>[a($e,{density:"compact"},{default:t(()=>[a(Y,null,{prepend:t(()=>[a(I,{size:"small"},{default:t(()=>e[6]||(e[6]=[v("mdi-account")])),_:1})]),default:t(()=>[a(Z,null,{default:t(()=>e[7]||(e[7]=[v("Speaker")])),_:1}),a(ee,null,{default:t(()=>[v(w(l.value.speakerName)+" ("+w(l.value.speakerId)+")",1)]),_:1})]),_:1}),a(Y,null,{prepend:t(()=>[a(I,{size:"small"},{default:t(()=>e[8]||(e[8]=[v("mdi-briefcase")])),_:1})]),default:t(()=>[a(Z,null,{default:t(()=>e[9]||(e[9]=[v("Occupation")])),_:1}),a(ee,null,{default:t(()=>[v(w(l.value.occupation),1)]),_:1})]),_:1}),a(Y,null,{prepend:t(()=>[a(I,{size:"small"},{default:t(()=>e[10]||(e[10]=[v("mdi-file-document")])),_:1})]),default:t(()=>[a(Z,null,{default:t(()=>e[11]||(e[11]=[v("Text Type")])),_:1}),a(ee,null,{default:t(()=>[v(w(l.value.textType),1)]),_:1})]),_:1}),a(Y,null,{prepend:t(()=>[a(I,{size:"small"},{default:t(()=>e[12]||(e[12]=[v("mdi-counter")])),_:1})]),default:t(()=>[a(Z,null,{default:t(()=>e[13]||(e[13]=[v("Statistics")])),_:1}),a(ee,null,{default:t(()=>[v(w(g.value.length||_.value.length)+" verses, "+w(l.value.tokens)+" tokens, "+w(U.value)+" annotated ",1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})):P("",!0)])]),m.value?(i(),G(re,{key:0,type:"error",class:"mx-4 mt-2",dismissible:"","onClick:close":e[0]||(e[0]=p=>m.value="")},{default:t(()=>[v(w(m.value),1)]),_:1})):P("",!0),l.value?(i(),f("div",ct,[r("div",vt,[r("div",ft,[r("div",null,[N.value&&!k.value?(i(),f("div",mt,[a(re,{type:"info",variant:"tonal",density:"compact",class:"mb-0"},{default:t(()=>[r("div",pt,[r("div",null,[e[14]||(e[14]=r("div",{class:"font-weight-medium"},"Audio available",-1)),r("div",ht,"Download audio file ("+w(O.value)+" MB) to enable playback",1)]),a(Q,{color:"primary",size:"small",variant:"elevated",onClick:J,loading:B.value},{default:t(()=>[a(I,{start:""},{default:t(()=>e[15]||(e[15]=[v("mdi-download")])),_:1}),e[16]||(e[16]=v(" Download "))]),_:1},8,["loading"])])]),_:1})])):(i(),f("div",yt,[k.value?(i(),G(st,{key:0,src:k.value,"audio-ref":c.value,onTimeupdate:ke,onPlay:e[1]||(e[1]=p=>S.value=!0),onPause:e[2]||(e[2]=p=>S.value=!1),onEnded:e[3]||(e[3]=p=>S.value=!1),ref_key:"audioPlayerRef",ref:M},null,8,["src","audio-ref"])):!o.value&&!N.value?(i(),f("div",gt," No audio available ")):o.value||B.value?(i(),G(ie,{key:2,indeterminate:"",size:"20",width:"2"})):P("",!0)]))]),r("div",kt,[u.value?(i(),f("div",wt,[a(ie,{indeterminate:""})])):g.value.length>0?(i(),f("div",_t,[a(Ke,{ref_key:"annotationDisplayRef",ref:b,utterances:g.value,"is-loading":!1,error:m.value,"highlighted-utterance":T.value,onUtteranceClick:ge},null,8,["utterances","error","highlighted-utterance"])])):(i(),f("div",bt,[a(I,{size:"48",class:"mb-2"},{default:t(()=>e[17]||(e[17]=[v("mdi-text-box-remove")])),_:1}),e[18]||(e[18]=r("div",null,"No transcription available",-1))]))])])])])):u.value?P("",!0):(i(),f("div",Tt,[a(I,{size:"64",class:"mb-4"},{default:t(()=>e[19]||(e[19]=[v("mdi-alert")])),_:1}),e[21]||(e[21]=r("h2",{class:"text-h6 mb-2"},"Text Not Found",-1)),r("p",null,"Unable to load data for text ID: "+w(y.value),1),a(Q,{color:"primary",to:{name:"MASCBrowser"},class:"mt-4"},{default:t(()=>e[20]||(e[20]=[v(" Back to MASC Browser ")])),_:1})]))]))}}),jt=se(xt,[["__scopeId","data-v-83360b63"]]);export{jt as default};
