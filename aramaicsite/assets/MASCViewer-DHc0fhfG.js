import{b as Z,x as he,r as g,c as R,aA as le,o as r,f,n as d,k,m as A,p as L,ax as Q,a5 as ue,F as W,j as v,_ as ee,e as Y,g as a,aX as oe,v as X,h as t,i as ie,aB as ye,av as I,at as de,W as ge,as as _e,V as ae,I as ke}from"./index-A2dtmQVC.js";import{d as ce,V as be,a as D,m as se,b as ne}from"./VDataTable-DMeGM1hK.js";import{a as we}from"./index-BrL7OF0L.js";import{V as ve,a as fe,b as pe}from"./VCard-LJ0MEwbm.js";import{f as re,a as Te,b as G,c as J,g as K,d as xe}from"./VSelect-D_HGNlPD.js";import"./IDB-CUIdphEQ.js";import"./index-Dob3nYDb.js";import"./VAvatar-CkIPtK95.js";import"./transition-BltgP3Ds.js";import"./index-BTjyK_6c.js";import"./VCheckboxBtn-Dg2Z5dYp.js";import"./VField-tCl29vn-.js";import"./VTable-ShOZddZQ.js";import"./VTextField-UgTcV7em.js";import"./VOverlay-B08zSa0t.js";import"./scopeId-C1S2p8LD.js";import"./dialog-transition-CTK6XPPA.js";import"./VSlideGroup-OnTGAZpu.js";function me(){const B=o=>!!(o.annotation&&o.annotation!==o.lemma),$=o=>B(o)||o.isArabic;return{shouldShowAnnotation:B,hasVisibleAnnotation:$,shouldShowIndicator:o=>B(o),shouldBeClickable:o=>$(o)}}const Ae={class:"annotated-token-wrapper"},$e=["aria-label"],Ce={class:"surface"},Se={key:0,class:"annotation-indicator"},Me={key:1,class:"arabic-indicator"},Ue={key:2,class:"inline-lemma"},Ve={class:"tooltip-content"},Be=Z({__name:"AnnotatedToken",props:{token:{},displayMode:{default:"indicators"},showAnnotations:{type:Boolean,default:!0}},setup(B){const $=B,{token:n,displayMode:m}=he($),{shouldShowAnnotation:o,hasVisibleAnnotation:h,shouldShowIndicator:u,shouldBeClickable:M}=me(),b=g(!1),U=g(),i=g({top:0,left:0,arrow:"bottom"});let s=null;const _=R(()=>({"has-lemma":!!n.value.lemma,"has-variants":!!(n.value.variants&&n.value.variants.length>0),"has-morphology":!!(n.value.morphology&&n.value.morphology.length>0),"has-prefix":!!n.value.prefix,"has-annotation":u(n.value),"is-arabic":n.value.isArabic,"is-clickable":M(n.value),[`display-${m.value}`]:!0})),p=R(()=>m.value==="indicators"||m.value==="detailed"),y=R(()=>{const V=[`Word: ${n.value.surface}`];return n.value.lemma&&V.push(`Lemma: ${n.value.lemma}`),n.value.variants&&n.value.variants.length>0&&V.push(`Variants: ${n.value.variants.join(", ")}`),n.value.isArabic&&V.push("Arabic"),V.join(", ")}),l=V=>{m.value!=="minimal"&&h($.token)&&(s=setTimeout(()=>{T(V),b.value=!0},300))},T=V=>{const P=V.target.getBoundingClientRect(),q=200,te=60,z=5;let j=P.top-te-z,E=P.left+P.width/2-q/2,c="bottom";j<z&&(j=P.bottom+z,c="top"),E<z&&(E=z),E+q>window.innerWidth-z&&(E=window.innerWidth-q-z),i.value={top:j,left:E,arrow:c}},C=()=>{s&&(clearTimeout(s),s=null),b.value=!1};return le(()=>{s&&clearTimeout(s)}),(V,N)=>(r(),f("span",Ae,[d("span",{class:Q(["annotated-token",_.value]),onMouseenter:l,onMouseleave:C,"aria-label":y.value},[d("span",Ce,k(A(n).surface),1),p.value&&A(u)(A(n))?(r(),f("sup",Se,"°")):p.value&&A(n).isArabic&&!A(u)(A(n))?(r(),f("sup",Me,"ع")):L("",!0),A(m)==="inline"&&A(n).lemma?(r(),f("span",Ue," ("+k(A(n).lemma)+") ",1)):L("",!0)],42,$e),b.value&&A(n)&&A(h)(A(n))?(r(),f("div",{key:0,class:Q(["annotation-tooltip",`arrow-${i.value.arrow}`]),ref_key:"tooltip",ref:U,style:ue({top:`${i.value.top}px`,left:`${i.value.left}px`})},[d("div",Ve,[A(o)(A(n))?(r(),f(W,{key:0},[v(k(A(n).annotation),1)],64)):A(n).isArabic?(r(),f(W,{key:1},[v(" Arabic ")],64)):L("",!0)])],6)):L("",!0)]))}}),Ie=ee(Be,[["__scopeId","data-v-f5320d92"]]),Re={class:"annotation-display"},Le={key:0,class:"text-center pa-8"},Pe={key:2,class:"utterances-container"},ze=["onClick"],Ee={class:"d-flex ga-3"},De={class:"utterance-number mr-2"},Ne={class:"flex-grow-1"},qe={class:"detailed-tokens"},Fe=["onClick"],Oe={key:0,class:"utterance-expansion mt-3"},We={key:3,class:"text-center pa-8 text-grey"},je=Z({__name:"AnnotationDisplay",props:{utterances:{},isLoading:{type:Boolean,default:!1},error:{default:""},highlightedUtterance:{default:-1}},emits:["utterance-click"],setup(B,{expose:$}){const n=B,m=g(new Set),{shouldShowAnnotation:o}=me(),h=[{title:"Surface",key:"surface",sortable:!1},{title:"Annotation",key:"annotation",sortable:!1}],u=R(()=>{if(!n.utterances||n.utterances.length===0)return{totalTokens:0,annotatedTokens:0,arabicTokens:0,morphologyTokens:0};let i=0,s=0,_=0,p=0;try{for(const y of n.utterances)if(y.tokens){i+=y.tokens.length;for(const l of y.tokens)o(l)&&s++,l.isArabic&&_++,l.morphology&&l.morphology.length>0&&p++}}catch{}return{totalTokens:i,annotatedTokens:s,arabicTokens:_,morphologyTokens:p}});R(()=>u.value.totalTokens),R(()=>u.value.annotatedTokens),R(()=>u.value.arabicTokens),R(()=>u.value.morphologyTokens),$({statistics:u});const M=i=>{const s=new Set(m.value);s.has(i)?s.delete(i):s.add(i),m.value=s},b=new Map,U=i=>{if(b.has(i.number))return b.get(i.number);const s=new Set,_=i.tokens.filter(p=>o(p)||p.isArabic||p.prefix).filter(p=>{const y=`${p.surface}|${p.annotation||"—"}`;return s.has(y)?!1:(s.add(y),!0)}).map(p=>({surface:p.surface,annotation:o(p)?p.annotation:p.isArabic?"Arabic":"—"}));return b.set(i.number,_),_};return Y(()=>n.utterances,()=>{b.clear()},{immediate:!0}),(i,s)=>(r(),f("div",Re,[i.isLoading?(r(),f("div",Le,[a(oe,{indeterminate:""}),s[0]||(s[0]=d("div",{class:"mt-2"},"Parsing annotations...",-1))])):i.error?(r(),X(ce,{key:1,type:"error",class:"mb-4"},{default:t(()=>[v(k(i.error),1)]),_:1})):i.utterances.length>0?(r(),f("div",Pe,[(r(!0),f(W,null,ie(i.utterances,(_,p)=>(r(),f("div",{key:`utterance-${_.number}-${p}`,class:"utterance-item",onClick:y=>i.$emit("utterance-click",_.number)},[d("div",Ee,[d("div",{class:Q(["d-flex align-start flex-grow-1",{"utterance-highlighted":i.highlightedUtterance===_.number}])},[d("span",De,k(_.number),1),d("div",Ne,[d("div",qe,[(r(!0),f(W,null,ie(_.tokens,(y,l)=>(r(),f(W,{key:`detailed-${y.position}-${l}`},[a(Ie,{token:y,"display-mode":"detailed","show-annotations":!0,class:"detailed-token"},null,8,["token"]),y.spaceAfter?(r(),f(W,{key:0},[v(k(" "))],64)):L("",!0)],64))),128))])])],2),d("button",{class:"expand-button",onClick:ye(y=>M(_.number),["stop"])},[a(I,{size:"small",class:Q(["expand-icon",{rotated:m.value.has(_.number)}])},{default:t(()=>s[1]||(s[1]=[v(k("mdi-chevron-right"))])),_:2},1032,["class"])],8,Fe)]),a(we,null,{default:t(()=>[m.value.has(_.number)?(r(),f("div",Oe,[a(ve,{variant:"outlined",density:"compact"},{default:t(()=>[a(fe,{class:"text-subtitle-2"},{default:t(()=>s[2]||(s[2]=[v(" Token Analysis ")])),_:1}),a(pe,null,{default:t(()=>[a(be,{headers:h,items:U(_),"items-per-page":-1,density:"compact","hide-default-footer":"",class:"token-analysis-table"},null,8,["items"])]),_:2},1024)]),_:2},1024)])):L("",!0)]),_:2},1024)],8,ze))),128))])):(r(),f("div",We,[a(I,{size:"48",class:"mb-2"},{default:t(()=>s[3]||(s[3]=[v("mdi-text-box-remove")])),_:1}),s[4]||(s[4]=d("div",null,"No annotations to display",-1))]))]))}}),Xe=ee(je,[["__scopeId","data-v-b3b06f8e"]]),He={class:"minimal-audio-player"},Ge=["disabled"],Je={key:0,width:"32",height:"32",viewBox:"0 0 24 24",fill:"none"},Ke={key:1,width:"32",height:"32",viewBox:"0 0 24 24",fill:"none"},Qe={class:"time-display"},Ye={class:"progress-bar"},Ze=Z({__name:"MinimalAudioPlayer",props:{src:{},audioRef:{}},emits:["play","pause","ended","timeupdate"],setup(B,{expose:$,emit:n}){const m=B,o=n,h=g(),u=g(!1),M=g(0),b=g(0),U=g(!1),i=R(()=>b.value?M.value/b.value*100:0),s=l=>{const T=Math.floor(l/60),C=Math.floor(l%60);return`${T}:${C.toString().padStart(2,"0")}`},_=()=>{h.value&&(u.value?h.value.pause():h.value.play())},p=l=>{if(!h.value||!b.value)return;const C=l.currentTarget.getBoundingClientRect(),P=(l.clientX-C.left)/C.width*b.value;h.value.currentTime=P,M.value=P},y=()=>{m.audioRef?h.value=m.audioRef:h.value=new Audio(m.src);const l=h.value;l.addEventListener("loadedmetadata",()=>{b.value=l.duration,U.value=!0}),l.addEventListener("timeupdate",()=>{M.value=l.currentTime,o("timeupdate",l.currentTime)}),l.addEventListener("play",()=>{u.value=!0,o("play")}),l.addEventListener("pause",()=>{u.value=!1,o("pause")}),l.addEventListener("ended",()=>{u.value=!1,o("ended")}),l.readyState>=1&&(b.value=l.duration,U.value=!0)};return Y(()=>m.src,l=>{h.value&&!m.audioRef&&(h.value.src=l,U.value=!1,M.value=0,b.value=0)}),de(()=>{y()}),le(()=>{h.value&&!m.audioRef&&(h.value.pause(),h.value.src="")}),$({audio:h}),(l,T)=>(r(),f("div",He,[d("button",{class:"play-button",onClick:_,disabled:!U.value},[u.value?(r(),f("svg",Ke,T[1]||(T[1]=[d("rect",{x:"6",y:"4",width:"4",height:"16",fill:"currentColor"},null,-1),d("rect",{x:"14",y:"4",width:"4",height:"16",fill:"currentColor"},null,-1)]))):(r(),f("svg",Je,T[0]||(T[0]=[d("path",{d:"M8 5v14l11-7z",fill:"currentColor"},null,-1)])))],8,Ge),d("div",Qe,k(s(M.value))+" / "+k(s(b.value)),1),d("div",{class:"progress-container",onClick:p},[d("div",Ye,[d("div",{class:"progress-fill",style:ue({width:i.value+"%"})},null,4)])])]))}}),et=ee(Ze,[["__scopeId","data-v-40c28804"]]),tt={class:"masc-viewer-layout"},at={class:"viewer-header"},st={class:"header-content"},nt={key:0,class:"title-section d-flex align-baseline flex-wrap ga-16"},ot={class:"text-h6 mb-0"},lt={class:"text-body-2"},it={key:1,class:"viewer-body"},rt={class:"content-area"},ut={class:"transcription-section"},dt={class:"controls-bar"},ct={class:"audio-controls full-width"},vt={key:1,class:"no-audio-text"},ft={class:"utterances-scroll"},pt={key:0,class:"text-center pa-8"},mt={key:1},ht={key:3,class:"text-center pa-4 text-grey"},yt={key:2,class:"empty-state"},gt=Z({__name:"MASCViewer",setup(B){const $=ge(),n=_e(),m=g($.params.textId),o=g(null),h=g(null),u=g(null),M=g(null),b=g(null),U=g("full"),i=g(!0),s=g(!0),_=g([]),p=g([]),y=g(""),l=g(new Map),T=g(-1),C=g(!1),V=R(()=>b.value?b.value.statistics.annotatedTokens:0),N=g({plainUtterances:[],surfaceUtterances:[],annotatedUtterances:[],loaded:!1}),P=async()=>{try{const[c,e]=await Promise.all([D.getTranscription(m.value,!1),D.getTranscription(m.value,!0)]);if(!c||!e)return;N.value={plainUtterances:ne.parseTranscription(c),surfaceUtterances:ne.parseLemmatizedTranscription(e),annotatedUtterances:ne.parseAnnotatedTranscription(e),loaded:!0},q()}catch{y.value="Failed to load transcription"}},q=()=>{if(N.value.loaded)switch(U.value){case"plain":_.value=N.value.plainUtterances,p.value=[];break;case"full":_.value=[],p.value=N.value.annotatedUtterances;break}},te=async()=>{s.value=!0;try{const c=await D.getAudioBlob(m.value);c&&(h.value=D.createAudioUrl(c));const e=await D.getUtteranceTimings(m.value);e&&(l.value=e)}catch{}finally{s.value=!1}},z=c=>{if(!u.value||!l.value.has(c))return;const e=l.value.get(c);e&&(T.value===c&&C.value?u.value.pause():(u.value.currentTime=e.start,C.value||u.value.play()))},j=()=>{if(!u.value||l.value.size===0)return;const c=u.value.currentTime;let e=-1;for(const[w,S]of l.value)if(c>=S.start&&c<S.end){e=w;break}if(e!==T.value){const w=T.value;T.value=e,e>0&&(C.value||Math.abs(e-w)>1)&&E(e)}},E=c=>{const e=document.querySelector(".utterances-scroll");if(!e)return;let w=null;if(U.value==="full"){const S=e.querySelectorAll(".utterance-item");S.length>0&&S.forEach(x=>{var F;const H=x.querySelector(".utterance-number");H&&((F=H.textContent)==null?void 0:F.trim())===String(c)&&(w=x)})}else{const S=e.querySelectorAll(".utterance-item"),x=c-1;x>=0&&x<S.length&&(w=S[x])}if(w){const S=e.getBoundingClientRect(),O=w.getBoundingClientRect().top-S.top+e.scrollTop-100;e.scrollTo({top:Math.max(0,O),behavior:"smooth"})}};return Y(U,()=>{q()}),Y(M,c=>{c&&c.audio&&(u.value=c.audio)}),de(async()=>{try{let c=await D.isDataLoaded();if(!c)if(await se.initialize(),await se.isDataReady())await D.setOnlineMode(se),c=!0;else if($.query.from==="browser"){y.value="Unable to load MASC data. Please try downloading the corpus.",i.value=!1,s.value=!1;return}else{await n.push({name:"MASCBrowser",query:{returnTo:$.fullPath}});return}const e=await D.getMetadata();if(o.value=e.find(w=>w.textId===m.value)||null,o.value){await P(),i.value=!1,await te();const w=$.query.utterance,S=$.query.autoplay==="true";if(w){const x=parseInt(w);isNaN(x)||(async()=>{let F=0;for(;!u.value&&F<20;)await new Promise(O=>setTimeout(O,100)),F++;if(u.value&&l.value.has(x)){const O=l.value.get(x);if(O&&(E(x),T.value=x,u.value.currentTime=O.start,S))try{await u.value.play()}catch{}}else E(x),T.value=x,setTimeout(()=>{T.value===x&&!C.value&&(T.value=-1)},3e3)})()}}else i.value=!1,s.value=!1}catch{y.value="Failed to load MASC data",i.value=!1,s.value=!1}}),le(()=>{u.value&&(u.value.pause(),u.value.currentTime=0),h.value&&URL.revokeObjectURL(h.value)}),(c,e)=>(r(),f("div",tt,[d("div",at,[d("div",st,[a(ae,{variant:"text",to:{name:"MASCBrowser"}},{default:t(()=>[a(I,null,{default:t(()=>e[4]||(e[4]=[v("mdi-arrow-left")])),_:1})]),_:1}),o.value?(r(),f("div",nt,[d("h1",ot,k(o.value.title),1),d("div",lt,[v(k(o.value.textId)+" — "+k(o.value.speakerName)+" ",1),a(re,{size:"x-small",class:"ml-2"},{default:t(()=>[v(k(o.value.gender),1)]),_:1}),a(re,{size:"x-small",class:"ml-1"},{default:t(()=>[v("Age: "+k(o.value.age),1)]),_:1})])])):L("",!0),o.value?(r(),X(xe,{key:1},{activator:t(({props:w})=>[a(ae,ke(w,{variant:"text",size:"x-large",icon:""}),{default:t(()=>[a(I,{size:"28",color:"grey-darken-1"},{default:t(()=>e[5]||(e[5]=[v("mdi-information-outline")])),_:1})]),_:2},1040)]),default:t(()=>[a(ve,{"min-width":"300"},{default:t(()=>[a(fe,{class:"text-body-1"}),a(pe,null,{default:t(()=>[a(Te,{density:"compact"},{default:t(()=>[a(G,null,{prepend:t(()=>[a(I,{size:"small"},{default:t(()=>e[6]||(e[6]=[v("mdi-account")])),_:1})]),default:t(()=>[a(J,null,{default:t(()=>e[7]||(e[7]=[v("Speaker")])),_:1}),a(K,null,{default:t(()=>[v(k(o.value.speakerName)+" ("+k(o.value.speakerId)+")",1)]),_:1})]),_:1}),a(G,null,{prepend:t(()=>[a(I,{size:"small"},{default:t(()=>e[8]||(e[8]=[v("mdi-briefcase")])),_:1})]),default:t(()=>[a(J,null,{default:t(()=>e[9]||(e[9]=[v("Occupation")])),_:1}),a(K,null,{default:t(()=>[v(k(o.value.occupation),1)]),_:1})]),_:1}),a(G,null,{prepend:t(()=>[a(I,{size:"small"},{default:t(()=>e[10]||(e[10]=[v("mdi-file-document")])),_:1})]),default:t(()=>[a(J,null,{default:t(()=>e[11]||(e[11]=[v("Text Type")])),_:1}),a(K,null,{default:t(()=>[v(k(o.value.textType),1)]),_:1})]),_:1}),a(G,null,{prepend:t(()=>[a(I,{size:"small"},{default:t(()=>e[12]||(e[12]=[v("mdi-counter")])),_:1})]),default:t(()=>[a(J,null,{default:t(()=>e[13]||(e[13]=[v("Statistics")])),_:1}),a(K,null,{default:t(()=>[v(k(p.value.length||_.value.length)+" verses, "+k(o.value.tokens)+" tokens, "+k(V.value)+" annotated ",1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})):L("",!0)])]),y.value?(r(),X(ce,{key:0,type:"error",class:"mx-4 mt-2",dismissible:"","onClick:close":e[0]||(e[0]=w=>y.value="")},{default:t(()=>[v(k(y.value),1)]),_:1})):L("",!0),o.value?(r(),f("div",it,[d("div",rt,[d("div",ut,[d("div",dt,[d("div",ct,[h.value?(r(),X(et,{key:0,src:h.value,"audio-ref":u.value,onTimeupdate:j,onPlay:e[1]||(e[1]=w=>C.value=!0),onPause:e[2]||(e[2]=w=>C.value=!1),onEnded:e[3]||(e[3]=w=>C.value=!1),ref_key:"audioPlayerRef",ref:M},null,8,["src","audio-ref"])):s.value?(r(),X(oe,{key:2,indeterminate:"",size:"20",width:"2"})):(r(),f("div",vt," No audio available "))])]),d("div",ft,[i.value?(r(),f("div",pt,[a(oe,{indeterminate:""})])):p.value.length>0?(r(),f("div",mt,[a(Xe,{ref_key:"annotationDisplayRef",ref:b,utterances:p.value,"is-loading":!1,error:y.value,"highlighted-utterance":T.value,onUtteranceClick:z},null,8,["utterances","error","highlighted-utterance"])])):(r(),f("div",ht,[a(I,{size:"48",class:"mb-2"},{default:t(()=>e[14]||(e[14]=[v("mdi-text-box-remove")])),_:1}),e[15]||(e[15]=d("div",null,"No transcription available",-1))]))])])])])):i.value?L("",!0):(r(),f("div",yt,[a(I,{size:"64",class:"mb-4"},{default:t(()=>e[16]||(e[16]=[v("mdi-alert")])),_:1}),e[18]||(e[18]=d("h2",{class:"text-h6 mb-2"},"Text Not Found",-1)),d("p",null,"Unable to load data for text ID: "+k(m.value),1),a(ae,{color:"primary",to:{name:"MASCBrowser"},class:"mt-4"},{default:t(()=>e[17]||(e[17]=[v(" Back to MASC Browser ")])),_:1})]))]))}}),Et=ee(gt,[["__scopeId","data-v-eb36a5e7"]]);export{Et as default};
