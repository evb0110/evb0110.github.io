import{b as ee,x as ge,r as g,c as L,b3 as ie,o as r,f,n as d,k as _,m as A,p as z,ax as Y,a5 as de,F as O,j as v,_ as te,e as Z,g as a,aW as le,v as j,h as t,i as re,aA as ke,av as R,at as ce,W as _e,as as be,V as oe,I as we}from"./index-DvjMLe6X.js";import{d as ve,V as Te,a as N,m as se,b as ne}from"./VDataTable-DdCULXOH.js";import{a as xe}from"./index-BOKEPjxP.js";import{V as fe,a as pe,b as me}from"./VCard-CSPgKFsb.js";import{f as ue,a as Ae,b as J,c as K,g as Q,d as $e}from"./VSelect-BwcVMbN8.js";import"./IDB-Q_OVpSNv.js";import"./index-Dob3nYDb.js";import"./VAvatar-C26X61lt.js";import"./transition-doC6Gg-r.js";import"./index-DSWjLB5g.js";import"./VCheckboxBtn-C8dSElMl.js";import"./VField-DKHeGfbT.js";import"./VTable-Bk-vG4j3.js";import"./VTextField-B-m9Y-o5.js";import"./VOverlay-BT-Q7HOr.js";import"./scopeId-BA0bc1gq.js";import"./dialog-transition-DVdY57GP.js";import"./VSlideGroup-WKISltNn.js";function he(){const I=o=>!!(o.annotation&&o.annotation!==o.lemma),$=o=>I(o)||o.isArabic;return{shouldShowAnnotation:I,hasVisibleAnnotation:$,shouldShowIndicator:o=>I(o),shouldBeClickable:o=>$(o)}}const Ce={class:"annotated-token-wrapper"},Se=["aria-label"],Me={class:"surface"},Ve={key:0,class:"annotation-indicator"},Ue={key:1,class:"arabic-indicator"},Ie={key:2,class:"inline-lemma"},Be={class:"tooltip-content"},Re=ee({__name:"AnnotatedToken",props:{token:{},displayMode:{default:"indicators"},showAnnotations:{type:Boolean,default:!0}},setup(I){const $=I,{token:n,displayMode:p}=ge($),{shouldShowAnnotation:o,hasVisibleAnnotation:y,shouldShowIndicator:u,shouldBeClickable:S}=he(),b=g(!1),M=g(),i=g({top:0,left:0,arrow:"bottom"});let s=null;const k=L(()=>({"has-lemma":!!n.value.lemma,"has-variants":!!(n.value.variants&&n.value.variants.length>0),"has-morphology":!!(n.value.morphology&&n.value.morphology.length>0),"has-prefix":!!n.value.prefix,"has-annotation":u(n.value),"is-arabic":n.value.isArabic,"is-clickable":S(n.value),[`display-${p.value}`]:!0})),m=L(()=>p.value==="indicators"||p.value==="detailed"),h=L(()=>{const V=[`Word: ${n.value.surface}`];return n.value.lemma&&V.push(`Lemma: ${n.value.lemma}`),n.value.variants&&n.value.variants.length>0&&V.push(`Variants: ${n.value.variants.join(", ")}`),n.value.isArabic&&V.push("Arabic"),V.join(", ")}),l=V=>{p.value!=="minimal"&&y($.token)&&(s=setTimeout(()=>{w(V),b.value=!0},300))},w=V=>{const P=V.target.getBoundingClientRect(),F=200,ae=60,E=5;let W=P.top-ae-E,D=P.left+P.width/2-F/2,c="bottom";W<E&&(W=P.bottom+E,c="top"),D<E&&(D=E),D+F>window.innerWidth-E&&(D=window.innerWidth-F-E),i.value={top:W,left:D,arrow:c}},C=()=>{s&&(clearTimeout(s),s=null),b.value=!1};return ie(()=>{s&&clearTimeout(s)}),(V,q)=>(r(),f("span",Ce,[d("span",{class:Y(["annotated-token",k.value]),onMouseenter:l,onMouseleave:C,"aria-label":h.value},[d("span",Me,_(A(n).surface),1),m.value&&A(u)(A(n))?(r(),f("sup",Ve,"°")):m.value&&A(n).isArabic&&!A(u)(A(n))?(r(),f("sup",Ue,"ع")):z("",!0),A(p)==="inline"&&A(n).lemma?(r(),f("span",Ie," ("+_(A(n).lemma)+") ",1)):z("",!0)],42,Se),b.value&&A(n)&&A(y)(A(n))?(r(),f("div",{key:0,class:Y(["annotation-tooltip",`arrow-${i.value.arrow}`]),ref_key:"tooltip",ref:M,style:de({top:`${i.value.top}px`,left:`${i.value.left}px`})},[d("div",Be,[A(o)(A(n))?(r(),f(O,{key:0},[v(_(A(n).annotation),1)],64)):A(n).isArabic?(r(),f(O,{key:1},[v(" Arabic ")],64)):z("",!0)])],6)):z("",!0)]))}}),Le=te(Re,[["__scopeId","data-v-d8e55b7a"]]),ze={class:"annotation-display"},Pe={key:0,class:"text-center pa-8"},Ee={key:2,class:"utterances-container"},De=["onClick"],Ne={class:"d-flex ga-3"},qe={class:"utterance-number mr-2"},Fe={class:"flex-grow-1"},Oe={class:"detailed-tokens"},We=["onClick"],je={key:0,class:"utterance-expansion mt-3"},Xe={key:3,class:"text-center pa-8 text-grey"},He=ee({__name:"AnnotationDisplay",props:{utterances:{},isLoading:{type:Boolean,default:!1},error:{default:""},highlightedUtterance:{default:-1}},emits:["utterance-click"],setup(I,{expose:$}){const n=I,p=g(new Set),{shouldShowAnnotation:o}=he(),y=[{title:"Surface",key:"surface",sortable:!1},{title:"Annotation",key:"annotation",sortable:!1}],u=L(()=>{if(!n.utterances||n.utterances.length===0)return{totalTokens:0,annotatedTokens:0,arabicTokens:0,morphologyTokens:0};let i=0,s=0,k=0,m=0;try{for(const h of n.utterances)if(h.tokens){i+=h.tokens.length;for(const l of h.tokens)o(l)&&s++,l.isArabic&&k++,l.morphology&&l.morphology.length>0&&m++}}catch(h){console.error("Error calculating statistics:",h)}return{totalTokens:i,annotatedTokens:s,arabicTokens:k,morphologyTokens:m}});L(()=>u.value.totalTokens),L(()=>u.value.annotatedTokens),L(()=>u.value.arabicTokens),L(()=>u.value.morphologyTokens),$({statistics:u});const S=i=>{const s=new Set(p.value);s.has(i)?s.delete(i):s.add(i),p.value=s},b=new Map,M=i=>{if(b.has(i.number))return b.get(i.number);const s=new Set,k=i.tokens.filter(m=>o(m)||m.isArabic||m.prefix).filter(m=>{const h=`${m.surface}|${m.annotation||"—"}`;return s.has(h)?!1:(s.add(h),!0)}).map(m=>({surface:m.surface,annotation:o(m)?m.annotation:m.isArabic?"Arabic":"—"}));return b.set(i.number,k),k};return Z(()=>n.utterances,()=>{b.clear()},{immediate:!0}),(i,s)=>(r(),f("div",ze,[i.isLoading?(r(),f("div",Pe,[a(le,{indeterminate:""}),s[0]||(s[0]=d("div",{class:"mt-2"},"Parsing annotations...",-1))])):i.error?(r(),j(ve,{key:1,type:"error",class:"mb-4"},{default:t(()=>[v(_(i.error),1)]),_:1})):i.utterances.length>0?(r(),f("div",Ee,[(r(!0),f(O,null,re(i.utterances,(k,m)=>(r(),f("div",{key:`utterance-${k.number}-${m}`,class:"utterance-item",onClick:h=>i.$emit("utterance-click",k.number)},[d("div",Ne,[d("div",{class:Y(["d-flex align-start flex-grow-1",{"utterance-highlighted":i.highlightedUtterance===k.number}])},[d("span",qe,_(k.number),1),d("div",Fe,[d("div",Oe,[(r(!0),f(O,null,re(k.tokens,(h,l)=>(r(),f(O,{key:`detailed-${h.position}-${l}`},[a(Le,{token:h,"display-mode":"detailed","show-annotations":!0,class:"detailed-token"},null,8,["token"]),h.spaceAfter?(r(),f(O,{key:0},[v(_(" "))],64)):z("",!0)],64))),128))])])],2),d("button",{class:"expand-button",onClick:ke(h=>S(k.number),["stop"])},[a(R,{size:"small",class:Y(["expand-icon",{rotated:p.value.has(k.number)}])},{default:t(()=>s[1]||(s[1]=[v(_("mdi-chevron-right"))])),_:2},1032,["class"])],8,We)]),a(xe,null,{default:t(()=>[p.value.has(k.number)?(r(),f("div",je,[a(fe,{variant:"outlined",density:"compact"},{default:t(()=>[a(pe,{class:"text-subtitle-2"},{default:t(()=>s[2]||(s[2]=[v(" Token Analysis ")])),_:1}),a(me,null,{default:t(()=>[a(Te,{headers:y,items:M(k),"items-per-page":-1,density:"compact","hide-default-footer":"",class:"token-analysis-table"},null,8,["items"])]),_:2},1024)]),_:2},1024)])):z("",!0)]),_:2},1024)],8,De))),128))])):(r(),f("div",Xe,[a(R,{size:"48",class:"mb-2"},{default:t(()=>s[3]||(s[3]=[v("mdi-text-box-remove")])),_:1}),s[4]||(s[4]=d("div",null,"No annotations to display",-1))]))]))}}),Ge=te(He,[["__scopeId","data-v-4111cf38"]]),Je={class:"minimal-audio-player"},Ke=["disabled"],Qe={key:0,width:"32",height:"32",viewBox:"0 0 24 24",fill:"none"},Ye={key:1,width:"32",height:"32",viewBox:"0 0 24 24",fill:"none"},Ze={class:"time-display"},et={class:"progress-bar"},tt=ee({__name:"MinimalAudioPlayer",props:{src:{},audioRef:{}},emits:["play","pause","ended","timeupdate"],setup(I,{expose:$,emit:n}){const p=I,o=n,y=g(),u=g(!1),S=g(0),b=g(0),M=g(!1),i=L(()=>b.value?S.value/b.value*100:0),s=l=>{const w=Math.floor(l/60),C=Math.floor(l%60);return`${w}:${C.toString().padStart(2,"0")}`},k=()=>{y.value&&(u.value?y.value.pause():y.value.play())},m=l=>{if(!y.value||!b.value)return;const C=l.currentTarget.getBoundingClientRect(),P=(l.clientX-C.left)/C.width*b.value;y.value.currentTime=P,S.value=P},h=()=>{p.audioRef?y.value=p.audioRef:y.value=new Audio(p.src);const l=y.value;l.addEventListener("loadedmetadata",()=>{b.value=l.duration,M.value=!0}),l.addEventListener("timeupdate",()=>{S.value=l.currentTime,o("timeupdate",l.currentTime)}),l.addEventListener("play",()=>{u.value=!0,o("play")}),l.addEventListener("pause",()=>{u.value=!1,o("pause")}),l.addEventListener("ended",()=>{u.value=!1,o("ended")}),l.readyState>=1&&(b.value=l.duration,M.value=!0)};return Z(()=>p.src,l=>{y.value&&!p.audioRef&&(y.value.src=l,M.value=!1,S.value=0,b.value=0)}),ce(()=>{h()}),ie(()=>{y.value&&!p.audioRef&&(y.value.pause(),y.value.src="")}),$({audio:y}),(l,w)=>(r(),f("div",Je,[d("button",{class:"play-button",onClick:k,disabled:!M.value},[u.value?(r(),f("svg",Ye,w[1]||(w[1]=[d("rect",{x:"6",y:"4",width:"4",height:"16",fill:"currentColor"},null,-1),d("rect",{x:"14",y:"4",width:"4",height:"16",fill:"currentColor"},null,-1)]))):(r(),f("svg",Qe,w[0]||(w[0]=[d("path",{d:"M8 5v14l11-7z",fill:"currentColor"},null,-1)])))],8,Ke),d("div",Ze,_(s(S.value))+" / "+_(s(b.value)),1),d("div",{class:"progress-container",onClick:m},[d("div",et,[d("div",{class:"progress-fill",style:de({width:i.value+"%"})},null,4)])])]))}}),at=te(tt,[["__scopeId","data-v-40c28804"]]),ot={class:"masc-viewer-layout"},st={class:"viewer-header"},nt={class:"header-content"},lt={key:0,class:"title-section d-flex align-baseline flex-wrap ga-16"},it={class:"text-h6 mb-0"},rt={class:"text-body-2"},ut={key:1,class:"viewer-body"},dt={class:"content-area"},ct={class:"transcription-section"},vt={class:"controls-bar"},ft={class:"audio-controls full-width"},pt={key:1,class:"no-audio-text"},mt={class:"utterances-scroll"},ht={key:0,class:"text-center pa-8"},yt={key:1},gt={key:3,class:"text-center pa-4 text-grey"},kt={key:2,class:"empty-state"},_t=ee({__name:"MASCViewer",setup(I){const $=_e(),n=be(),p=g($.params.textId),o=g(null),y=g(null),u=g(null),S=g(null),b=g(null),M=g("full"),i=g(!0),s=g(!0),k=g([]),m=g([]),h=g(""),l=g(new Map),w=g(-1),C=g(!1),V=L(()=>b.value?b.value.statistics.annotatedTokens:0),q=g({plainUtterances:[],surfaceUtterances:[],annotatedUtterances:[],loaded:!1}),P=async()=>{try{const[c,e]=await Promise.all([N.getTranscription(p.value,!1),N.getTranscription(p.value,!0)]);if(!c||!e)return;q.value={plainUtterances:ne.parseTranscription(c),surfaceUtterances:ne.parseLemmatizedTranscription(e),annotatedUtterances:ne.parseAnnotatedTranscription(e),loaded:!0},F()}catch(c){console.error("Error loading transcription:",c),h.value="Failed to load transcription"}},F=()=>{if(q.value.loaded)switch(M.value){case"plain":k.value=q.value.plainUtterances,m.value=[];break;case"full":k.value=[],m.value=q.value.annotatedUtterances;break}},ae=async()=>{s.value=!0;try{const c=await N.getAudioBlob(p.value);c&&(y.value=N.createAudioUrl(c));const e=await N.getUtteranceTimings(p.value);e&&(l.value=e)}catch(c){console.error("Error loading audio:",c)}finally{s.value=!1}},E=c=>{if(!u.value||!l.value.has(c))return;const e=l.value.get(c);e&&(w.value===c&&C.value?u.value.pause():(u.value.currentTime=e.start,C.value||u.value.play()))},W=()=>{if(!u.value||l.value.size===0)return;const c=u.value.currentTime;let e=-1;for(const[T,x]of l.value)if(c>=x.start&&c<x.end){e=T;break}if(e!==w.value){const T=w.value;w.value=e,e>0&&(C.value||Math.abs(e-T)>1)&&D(e)}},D=c=>{const e=document.querySelector(".utterances-scroll");if(!e)return;let T=null;if(M.value==="full"){const x=e.querySelectorAll(".utterance-item");x.length>0&&x.forEach(B=>{var X;const U=B.querySelector(".utterance-number");U&&((X=U.textContent)==null?void 0:X.trim())===String(c)&&(T=B)})}else{const x=e.querySelectorAll(".utterance-item"),B=c-1;B>=0&&B<x.length&&(T=x[B])}if(T){const x=e.getBoundingClientRect(),H=T.getBoundingClientRect().top-x.top+e.scrollTop-100;e.scrollTo({top:Math.max(0,H),behavior:"smooth"})}};return Z(M,()=>{F()}),Z(S,c=>{c&&c.audio&&(u.value=c.audio)}),ce(async()=>{var c;try{let e=await N.isDataLoaded();if(!e)if(console.log("MASC data not initialized, checking online service..."),await se.initialize(),await se.isDataReady())await N.setOnlineMode(se),e=!0;else if(console.error("MASC data not available"),$.query.from==="browser"){h.value="Unable to load MASC data. Please try downloading the corpus.",i.value=!1,s.value=!1;return}else{await n.push({name:"MASCBrowser",query:{returnTo:$.fullPath}});return}const T=await N.getMetadata();if(console.log("MASCViewer: Got metadata with",T.length,"speakers"),o.value=T.find(x=>x.textId===p.value)||null,console.log("MASCViewer: Found speaker:",(c=o.value)==null?void 0:c.speakerName,"for textId:",p.value),o.value){await P(),i.value=!1,await ae();const x=$.query.utterance,B=$.query.autoplay==="true";if(x){const U=parseInt(x);isNaN(U)||(async()=>{let H=0;for(;!u.value&&H<20;)await new Promise(G=>setTimeout(G,100)),H++;if(u.value&&l.value.has(U)){const G=l.value.get(U);if(G&&(D(U),w.value=U,u.value.currentTime=G.start,B))try{await u.value.play()}catch(ye){console.error("Autoplay failed:",ye)}}else D(U),w.value=U,setTimeout(()=>{w.value===U&&!C.value&&(w.value=-1)},3e3)})()}}else console.error("Speaker not found for textId:",p.value),i.value=!1,s.value=!1}catch(e){console.error("Error loading MASC data:",e),h.value="Failed to load MASC data",i.value=!1,s.value=!1}}),ie(()=>{u.value&&(u.value.pause(),u.value.currentTime=0),y.value&&URL.revokeObjectURL(y.value)}),(c,e)=>(r(),f("div",ot,[d("div",st,[d("div",nt,[a(oe,{variant:"text",to:{name:"MASCBrowser"}},{default:t(()=>[a(R,null,{default:t(()=>e[4]||(e[4]=[v("mdi-arrow-left")])),_:1})]),_:1}),o.value?(r(),f("div",lt,[d("h1",it,_(o.value.title),1),d("div",rt,[v(_(o.value.textId)+" — "+_(o.value.speakerName)+" ",1),a(ue,{size:"x-small",class:"ml-2"},{default:t(()=>[v(_(o.value.gender),1)]),_:1}),a(ue,{size:"x-small",class:"ml-1"},{default:t(()=>[v("Age: "+_(o.value.age),1)]),_:1})])])):z("",!0),o.value?(r(),j($e,{key:1},{activator:t(({props:T})=>[a(oe,we(T,{variant:"text",size:"x-large",icon:""}),{default:t(()=>[a(R,{size:"28",color:"grey-darken-1"},{default:t(()=>e[5]||(e[5]=[v("mdi-information-outline")])),_:1})]),_:2},1040)]),default:t(()=>[a(fe,{"min-width":"300"},{default:t(()=>[a(pe,{class:"text-body-1"}),a(me,null,{default:t(()=>[a(Ae,{density:"compact"},{default:t(()=>[a(J,null,{prepend:t(()=>[a(R,{size:"small"},{default:t(()=>e[6]||(e[6]=[v("mdi-account")])),_:1})]),default:t(()=>[a(K,null,{default:t(()=>e[7]||(e[7]=[v("Speaker")])),_:1}),a(Q,null,{default:t(()=>[v(_(o.value.speakerName)+" ("+_(o.value.speakerId)+")",1)]),_:1})]),_:1}),a(J,null,{prepend:t(()=>[a(R,{size:"small"},{default:t(()=>e[8]||(e[8]=[v("mdi-briefcase")])),_:1})]),default:t(()=>[a(K,null,{default:t(()=>e[9]||(e[9]=[v("Occupation")])),_:1}),a(Q,null,{default:t(()=>[v(_(o.value.occupation),1)]),_:1})]),_:1}),a(J,null,{prepend:t(()=>[a(R,{size:"small"},{default:t(()=>e[10]||(e[10]=[v("mdi-file-document")])),_:1})]),default:t(()=>[a(K,null,{default:t(()=>e[11]||(e[11]=[v("Text Type")])),_:1}),a(Q,null,{default:t(()=>[v(_(o.value.textType),1)]),_:1})]),_:1}),a(J,null,{prepend:t(()=>[a(R,{size:"small"},{default:t(()=>e[12]||(e[12]=[v("mdi-counter")])),_:1})]),default:t(()=>[a(K,null,{default:t(()=>e[13]||(e[13]=[v("Statistics")])),_:1}),a(Q,null,{default:t(()=>[v(_(m.value.length||k.value.length)+" verses, "+_(o.value.tokens)+" tokens, "+_(V.value)+" annotated ",1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})):z("",!0)])]),h.value?(r(),j(ve,{key:0,type:"error",class:"mx-4 mt-2",dismissible:"","onClick:close":e[0]||(e[0]=T=>h.value="")},{default:t(()=>[v(_(h.value),1)]),_:1})):z("",!0),o.value?(r(),f("div",ut,[d("div",dt,[d("div",ct,[d("div",vt,[d("div",ft,[y.value?(r(),j(at,{key:0,src:y.value,"audio-ref":u.value,onTimeupdate:W,onPlay:e[1]||(e[1]=T=>C.value=!0),onPause:e[2]||(e[2]=T=>C.value=!1),onEnded:e[3]||(e[3]=T=>C.value=!1),ref_key:"audioPlayerRef",ref:S},null,8,["src","audio-ref"])):s.value?(r(),j(le,{key:2,indeterminate:"",size:"20",width:"2"})):(r(),f("div",pt," No audio available "))])]),d("div",mt,[i.value?(r(),f("div",ht,[a(le,{indeterminate:""})])):m.value.length>0?(r(),f("div",yt,[a(Ge,{ref_key:"annotationDisplayRef",ref:b,utterances:m.value,"is-loading":!1,error:h.value,"highlighted-utterance":w.value,onUtteranceClick:E},null,8,["utterances","error","highlighted-utterance"])])):(r(),f("div",gt,[a(R,{size:"48",class:"mb-2"},{default:t(()=>e[14]||(e[14]=[v("mdi-text-box-remove")])),_:1}),e[15]||(e[15]=d("div",null,"No transcription available",-1))]))])])])])):i.value?z("",!0):(r(),f("div",kt,[a(R,{size:"64",class:"mb-4"},{default:t(()=>e[16]||(e[16]=[v("mdi-alert")])),_:1}),e[18]||(e[18]=d("h2",{class:"text-h6 mb-2"},"Text Not Found",-1)),d("p",null,"Unable to load data for text ID: "+_(p.value),1),a(oe,{color:"primary",to:{name:"MASCBrowser"},class:"mt-4"},{default:t(()=>e[17]||(e[17]=[v(" Back to MASC Browser ")])),_:1})]))]))}}),Dt=te(_t,[["__scopeId","data-v-97686498"]]);export{Dt as default};
